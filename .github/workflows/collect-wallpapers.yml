name: Collect Bing Wallpapers

on:
  schedule:
    # å…¨çƒç»Ÿä¸€é‡‡é›† - UTC 01:00 (ç¡®ä¿æ‰€æœ‰æ—¶åŒºå£çº¸å·²æ›´æ–°)
    - cron: "0 1 * * *"
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      target_country:
        description: "ç›®æ ‡å›½å®¶"
        required: false
        default: "China"
        type: choice
        options:
          - China
          - UnitedStates
          - UnitedKingdom
          - Japan
          - Germany
          - France
          - Spain
          - Italy
          - Russia
          - SouthKorea
          - Brazil
          - Australia
          - Canada
          - India
          - All
      collect_days:
        description: "æ”¶é›†å¤©æ•° (1-8)"
        required: false
        default: "1"
      resolution_code:
        description: "API è¯·æ±‚åˆ†è¾¨çŽ‡"
        required: false
        default: "FullHD"
        type: choice
        options:
          - Standard
          - FullHD
          - HD
          - UHD4K

permissions:
  contents: write
  actions: read

jobs:
  collect-wallpapers:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® .NET 10.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: æ¢å¤ä¾èµ–åŒ…
        run: dotnet restore src/BingWallpaperGallery.Collector/BingWallpaperGallery.Collector.csproj

      - name: æž„å»ºé¡¹ç›®
        run: dotnet build src/BingWallpaperGallery.Collector/BingWallpaperGallery.Collector.csproj --configuration Release --no-restore

      - name: æ™ºèƒ½é…ç½®æ”¶é›†å‚æ•°
        id: config
        run: |
          # èŽ·å–å½“å‰UTCæ—¶é—´
          CURRENT_UTC_HOUR=$(date -u +%H)
          CURRENT_UTC_MINUTE=$(date -u +%M)
          CURRENT_TIME="$CURRENT_UTC_HOUR:$CURRENT_UTC_MINUTE"

          echo "å½“å‰UTCæ—¶é—´: $CURRENT_TIME"

          # æ ¹æ®è§¦å‘æ–¹å¼ç¡®å®šé‡‡é›†ç­–ç•¥
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„å‚æ•°
            TARGET_COUNTRY="${{ github.event.inputs.target_country || 'China' }}"
            COLLECT_DAYS="${{ github.event.inputs.collect_days || '1' }}"
            RESOLUTION_CODE="${{ github.event.inputs.resolution_code || 'FullHD' }}"
            TRIGGER_TYPE="æ‰‹åŠ¨è§¦å‘"

            # æ£€æŸ¥æ˜¯å¦é€‰æ‹©"All"é€‰é¡¹
            if [ "$TARGET_COUNTRY" = "All" ]; then
              COLLECT_ALL="true"
              echo "ðŸŒ æ‰‹åŠ¨è§¦å‘æ¨¡å¼ - å…¨çƒç»Ÿä¸€é‡‡é›†æ‰€æœ‰å›½å®¶"
            else
              COLLECT_ALL="false"
              echo "ðŸŽ¯ æ‰‹åŠ¨è§¦å‘æ¨¡å¼ - é‡‡é›†æŒ‡å®šå›½å®¶: $TARGET_COUNTRY"
            fi
          else
            # å®šæ—¶è§¦å‘æ—¶ä½¿ç”¨å…¨çƒç»Ÿä¸€é‡‡é›†ç­–ç•¥
            TARGET_COUNTRY="All"
            COLLECT_DAYS="1"
            RESOLUTION_CODE="FullHD"
            COLLECT_ALL="true"
            TRIGGER_TYPE="å®šæ—¶è§¦å‘"
            echo "ðŸŒ å®šæ—¶è§¦å‘æ¨¡å¼ - å…¨çƒç»Ÿä¸€é‡‡é›†æ‰€æœ‰å›½å®¶"
          fi

          echo "æ”¶é›†é…ç½®:"
          echo "  - è§¦å‘æ–¹å¼: $TRIGGER_TYPE"
          echo "  - ç›®æ ‡å›½å®¶: $TARGET_COUNTRY"
          echo "  - æ”¶é›†å¤©æ•°: $COLLECT_DAYS"
          echo "  - åˆ†è¾¨çŽ‡: $RESOLUTION_CODE"
          echo "  - æ”¶é›†æ‰€æœ‰å›½å®¶: $COLLECT_ALL"

          # è®¾ç½®çŽ¯å¢ƒå˜é‡ï¼ˆæ›¿ä»£jqä¿®æ”¹é…ç½®æ–‡ä»¶ï¼‰
          echo "COLLECTIONOPTIONS__MARKETCODE=China" >> $GITHUB_ENV  # åœ¨CollectAllCountries=trueæ—¶ä¼šè¢«å¿½ç•¥
          echo "COLLECTIONOPTIONS__COLLECTDAYS=$COLLECT_DAYS" >> $GITHUB_ENV
          echo "COLLECTIONOPTIONS__RESOLUTIONCODE=$RESOLUTION_CODE" >> $GITHUB_ENV
          echo "COLLECTIONOPTIONS__COLLECTALLCOUNTRIES=$COLLECT_ALL" >> $GITHUB_ENV
          echo "COLLECTIONOPTIONS__MAXCONCURRENTREQUESTS=5" >> $GITHUB_ENV  # å¢žåŠ å¹¶å‘æ•°ä»¥å¤„ç†æ‰€æœ‰å›½å®¶
          echo "COLLECTIONOPTIONS__PRETTYJSONFORMAT=true" >> $GITHUB_ENV

          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "target_country=$TARGET_COUNTRY" >> $GITHUB_OUTPUT
          echo "collect_days=$COLLECT_DAYS" >> $GITHUB_OUTPUT
          echo "resolution_code=$RESOLUTION_CODE" >> $GITHUB_OUTPUT
          echo "trigger_type=$TRIGGER_TYPE" >> $GITHUB_OUTPUT

          echo ""
          echo "çŽ¯å¢ƒå˜é‡é…ç½®:"
          echo "  - COLLECTIONOPTIONS__MARKETCODE=China (åœ¨CollectAllCountries=trueæ—¶å¿½ç•¥)"
          echo "  - COLLECTIONOPTIONS__COLLECTDAYS=$COLLECT_DAYS"
          echo "  - COLLECTIONOPTIONS__RESOLUTIONCODE=$RESOLUTION_CODE"
          echo "  - COLLECTIONOPTIONS__COLLECTALLCOUNTRIES=$COLLECT_ALL"
          echo "  - COLLECTIONOPTIONS__MAXCONCURRENTREQUESTS=5"
          echo "  - COLLECTIONOPTIONS__PRETTYJSONFORMAT=true"

      - name: æ”¶é›†å£çº¸ä¿¡æ¯
        run: |
          echo "ðŸš€ å¼€å§‹æ”¶é›† ${{ steps.config.outputs.target_country }} çš„å£çº¸ä¿¡æ¯..."
          dotnet run --project src/BingWallpaperGallery.Collector/BingWallpaperGallery.Collector.csproj --configuration Release

      - name: é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æ•°æ®
        id: check_changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "å‘çŽ°æ–°çš„å£çº¸æ•°æ®"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰æ–°çš„å£çº¸æ•°æ®"
          fi

      - name: æäº¤å¹¶æŽ¨é€æ–°æ•°æ®
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          # æ·»åŠ æ‰€æœ‰æ–°æ–‡ä»¶
          git add archive/

          # èŽ·å–å½“å‰æ—¥æœŸ
          DATE=$(date +'%Y-%m-%d')
          TIME=$(date +'%H:%M UTC')

          # ç»Ÿè®¡æ–°å¢žçš„æ–‡ä»¶æ•°é‡
          NEW_FILES=$(git diff --cached --name-only | wc -l)

          # åˆ›å»ºè¯¦ç»†çš„æäº¤ä¿¡æ¯
          git commit -m "ðŸŒ… è‡ªåŠ¨æ”¶é›† ${{ steps.config.outputs.target_country }} ${DATE} çš„ Bing å£çº¸ä¿¡æ¯" \
                    -m "ðŸ“Š æ›´æ–°äº† ${NEW_FILES} ä¸ªæ–‡ä»¶" \
                    -m "â° æ”¶é›†æ—¶é—´: ${TIME}" \
                    -m "ðŸŒ ç›®æ ‡å›½å®¶: ${{ steps.config.outputs.target_country }}" \
                    -m "ðŸ¤– ç”± GitHub Actions è‡ªåŠ¨æ‰§è¡Œ"

          # æŽ¨é€åˆ°ä»“åº“
          git push

      - name: ç”Ÿæˆæ‘˜è¦æŠ¥å‘Š
        if: always()
        run: |
          echo "## ðŸ“Š Bingå£çº¸æ”¶é›†æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡Œæ—¶é—´:** $(date +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**è§¦å‘æ–¹å¼:** ${{ steps.config.outputs.trigger_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**ç›®æ ‡å›½å®¶:** ${{ steps.config.outputs.target_country }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ”¶é›†å¤©æ•°:** ${{ steps.config.outputs.collect_days }} å¤©" >> $GITHUB_STEP_SUMMARY
          echo "**åˆ†è¾¨çŽ‡:** ${{ steps.config.outputs.resolution_code }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… **çŠ¶æ€:** æˆåŠŸæ”¶é›†åˆ°æ–°çš„å£çº¸ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY

            # ç»Ÿè®¡ç›®æ ‡å›½å®¶çš„æ•°æ®æ–‡ä»¶
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸ“ˆ æ•°æ®ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| å›½å®¶/åœ°åŒº | JSONæ–‡ä»¶æ•° |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-----------|" >> $GITHUB_STEP_SUMMARY

            # æ˜¾ç¤ºç›®æ ‡å›½å®¶çš„æ–‡ä»¶ç»Ÿè®¡
            TARGET_COUNTRY="${{ steps.config.outputs.target_country }}"
            if [ "$TARGET_COUNTRY" = "All" ]; then
              # æ˜¾ç¤ºæ‰€æœ‰å›½å®¶çš„æ–‡ä»¶ç»Ÿè®¡
              echo "| å›½å®¶/åœ°åŒº | JSONæ–‡ä»¶æ•° |" >> $GITHUB_STEP_SUMMARY
              echo "|----------|-----------|" >> $GITHUB_STEP_SUMMARY
              for country_dir in archive/*/; do
                if [ -d "$country_dir" ]; then
                  country_name=$(basename "$country_dir")
                  file_count=$(find "$country_dir" -name "*.json" | wc -l)
                  echo "| $country_name | $file_count |" >> $GITHUB_STEP_SUMMARY
                fi
              done
            else
              # æ˜¾ç¤ºå•ä¸ªå›½å®¶çš„æ–‡ä»¶ç»Ÿè®¡
              if [ -d "archive/$TARGET_COUNTRY" ]; then
                file_count=$(find "archive/$TARGET_COUNTRY" -name "*.json" | wc -l)
                echo "| **$TARGET_COUNTRY** | **$file_count** |" >> $GITHUB_STEP_SUMMARY
              fi
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**æ€»æ–‡ä»¶æ•°:** $(find archive -name "*.json" | wc -l)" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **çŠ¶æ€:** æ²¡æœ‰å‘çŽ°æ–°çš„å£çº¸ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "å¯èƒ½åŽŸå› ï¼š" >> $GITHUB_STEP_SUMMARY
            echo "- ä»Šæ—¥å£çº¸å·²ç»æ”¶é›†è¿‡" >> $GITHUB_STEP_SUMMARY
            echo "- å¿…åº” API æš‚æ— æ›´æ–°" >> $GITHUB_STEP_SUMMARY
            echo "- ç›®æ ‡å›½å®¶ ${{ steps.config.outputs.target_country }} æš‚æ— æ–°æ•°æ®" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŒ å…¨çƒç»Ÿä¸€é‡‡é›†ç­–ç•¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ‰§è¡Œæ—¶é—´ | é‡‡é›†èŒƒå›´ | ç­–ç•¥è¯´æ˜Ž |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|----------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| UTC 01:00 | æ‰€æœ‰14ä¸ªå›½å®¶ | å…¨çƒç»Ÿä¸€é‡‡é›†ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š æ”¯æŒçš„å›½å®¶/åœ°åŒº:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ‡¨ðŸ‡³ China (ä¸­å›½) - ðŸ‡ºðŸ‡¸ UnitedStates (ç¾Žå›½)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ‡¬ðŸ‡§ UnitedKingdom (è‹±å›½) - ðŸ‡¯ðŸ‡µ Japan (æ—¥æœ¬)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ‡©ðŸ‡ª Germany (å¾·å›½) - ðŸ‡«ðŸ‡· France (æ³•å›½)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ‡ªðŸ‡¸ Spain (è¥¿ç­ç‰™) - ðŸ‡®ðŸ‡¹ Italy (æ„å¤§åˆ©)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ‡·ðŸ‡º Russia (ä¿„ç½—æ–¯) - ðŸ‡°ðŸ‡· SouthKorea (éŸ©å›½)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ‡§ðŸ‡· Brazil (å·´è¥¿) - ðŸ‡¦ðŸ‡º Australia (æ¾³å¤§åˆ©äºš)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ‡¨ðŸ‡¦ Canada (åŠ æ‹¿å¤§) - ðŸ‡®ðŸ‡³ India (å°åº¦)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*ðŸ’¡ æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼Œå¯è‡ªå®šä¹‰ç›®æ ‡å›½å®¶å’Œæ”¶é›†å‚æ•°*" >> $GITHUB_STEP_SUMMARY
