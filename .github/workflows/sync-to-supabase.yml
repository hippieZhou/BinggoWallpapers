name: Sync Wallpapers to Supabase

on:
  schedule:
    # åœ¨æ”¶é›†å£çº¸åŽè¿è¡Œï¼ˆUTC 01:30ï¼Œç¡®ä¿æ•°æ®å·²æ”¶é›†ï¼‰
    - cron: "30 1 * * *"
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_run:
    # åœ¨æ”¶é›†å£çº¸ workflow å®ŒæˆåŽè§¦å‘
    workflows: ["Collect Bing Wallpapers"]
    types:
      - completed

permissions:
  contents: read

jobs:
  sync-to-supabase:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' }}

    steps:
      - name: æ£€å‡ºä»£ç åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: å®‰è£… Python ä¾èµ–
        run: |
          pip install requests

      - name: åŒæ­¥æ•°æ®åˆ° Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "ðŸš€ å¼€å§‹åŒæ­¥æ•°æ®åˆ° Supabase..."
          
          # æ£€æŸ¥å¿…è¦çš„çŽ¯å¢ƒå˜é‡
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "âŒ é”™è¯¯: ç¼ºå°‘ Supabase é…ç½®"
            echo "è¯·åœ¨ GitHub Secrets ä¸­è®¾ç½®:"
            echo "  - SUPABASE_URL: Supabase é¡¹ç›® URL"
            echo "  - SUPABASE_SERVICE_ROLE_KEY: Supabase Service Role Key"
            exit 1
          fi
          
          # ä½¿ç”¨ Python è„šæœ¬åŒæ­¥æ•°æ®
          python3 scripts/sync_to_supabase.py

      - name: ç”ŸæˆåŒæ­¥æŠ¥å‘Š
        if: always()
        run: |
          echo "## ðŸ“Š Supabase åŒæ­¥æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡Œæ—¶é—´:** $(date +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **çŠ¶æ€:** æ•°æ®åŒæ­¥æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **çŠ¶æ€:** æ•°æ®åŒæ­¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
